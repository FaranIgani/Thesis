---
title: "Data"
format: html
editor: visual
---

```{r}
install.packages("hoopR")
```

```{r}
#season 2005-2025
nba_pbp <- hoopR::load_nba_pbp(season = 2005:2025)
nba_pbp
```

```{r}
library(dplyr)
library(stringr)
library(tidyr)
library(purrr)

# manual list of players, may work better
players <- c(
  "Shai Gilgeous-Alexander","Tyrese Maxey","Josh Hart","Devin Booker","Mikal Bridges",
  "Nikola Jokic","OG Anunoby","Kevin Durant","Jayson Tatum","Anthony Edwards",
  "De'Aaron Fox","Jamal Murray","Damian Lillard","Kyrie Irving","Trae Young",
  "DeMar DeRozan","Jalen Johnson","Jalen Brunson","Tyler Herro","Luka Doncic",
  "James Harden","Fred VanVleet","Zach LaVine","Cade Cunningham","Trey Murphy III",
  "Karl-Anthony Towns","Austin Reaves","LeBron James","Domantas Sabonis",
  "Kelly Oubre Jr.","Paolo Banchero","Bam Adebayo","Jaylen Brown",
  "Giannis Antetokounmpo","Derrick White","Tyrese Haliburton","Anthony Davis",
  "Victor Wembanyama",
  # 2020-2025
  "Keegan Murray","Brandon Miller","Christian Braun","Dyson Daniels","Franz Wagner",
  "Michael Porter Jr.","Rudy Gobert","Coby White","Brandon Ingram","Bilal Coulibaly",
  "Jalen Green","Scottie Barnes","Miles Bridges","Dejounte Murray","Julius Randle",
  "Ja Morant","Donovan Mitchell","Anfernee Simons","Desmond Bane","Nikola Vucevic",
  "Kawhi Leonard","Jimmy Butler","Jerami Grant","Tobias Harris","Paul George",
  "Joel Embiid","Grayson Allen","Terry Rozier","Jacob Gilyard","Pascal Siakam",
  "Darius Garland","CJ McCollum","LaMelo Ball","RaiQuan Gray","Kyle Kuzma",
  "Stephen Curry","Spencer Dinwiddie","Lauri Markkanen","Evan Mobley",
  "Kevin Porter Jr.","RJ Barrett",
  # 2015-2020
  "Aaron Jackson","Aaron Gordon","Andre Drummond","Andrew Wiggins","Austin Rivers",
  "Ben Simmons","Blake Griffin","Bojan Bogdanovic","Buddy Hield","Carmelo Anthony",
  "Cedi Osman","Chris Paul","Clint Capela","Collin Sexton","Deandre Ayton",
  "DeMarcus Cousins","Devonte' Graham","Draymond Green","Gary Harris",
  "Gary Trent Jr.","Gordon Hayward","Harrison Barnes","Jeff Teague","John Collins",
  "John Wall","Kentavious Caldwell-Pope","Khris Middleton","Klay Thompson",
  "Kyle Lowry","LaMarcus Aldridge","Malik Beasley","Marc Gasol","Marcus Smart",
  "Melvin Frazier Jr.","Mike Conley","P.J. Tucker","Rajon Rondo","Robert Covington",
  "Russell Westbrook","Steven Adams","Taj Gibson","Tim Hardaway Jr.","T.J. Warren",
  "Wesley Matthews","Will Barton","Zion Williamson",
  # 2010-2015
  "Al Horford","Al Jefferson","Al Thornton","Andrea Bargnani","Andrew Bogut",
  "Antawn Jamison","Arron Afflalo","Beno Udrih","Boris Diaw","Bradley Beal",
  "Brandon Knight","Brandon Roy","Caron Butler","Chris Bosh","Chris Kaman",
  "Darren Collison","David Lee","David West","DeAndre Jordan","Deron Williams",
  "Devin Harris","Dirk Nowitzki","Dorell Wright","Dwight Howard","Eric Bledsoe",
  "Eric Gordon","George Hill","Gerald Henderson","Gerald Wallace","Gilbert Arenas",
  "Goran Dragic","Greivis Vasquez","Isaiah Thomas","Jamal Crawford","Jason Kidd",
  "Joe Johnson","JR Smith","Kemba Walker","Kevin Love","Kevin Martin","Kobe Bryant",
  "Luol Deng","Metta World Peace","Michael Carter-Williams","Monta Ellis",
  "Nicolas Batum","O.J. Mayo","Paul Millsap","Paul Pierce","Pau Gasol","Ray Allen",
  "Raymond Felton","Ricky Rubio","Rudy Gay","Stephen Jackson","Thaddeus Young",
  "Tayshaun Prince","Ty Lawson","Tyreke Evans","Vince Carter",
  # 2005-2010
  "Allen Iverson","Al Harrington","Andre Kirilenko","Andre Miller","Baron Davis",
  "Ben Gordon","Brad Miller","Chauncey Billups","Corey Maggette","Cuttino Mobley",
  "Hedo Turkoglu","Jason Richardson","Jermaine O'Neal","Josh Childress","Josh Howard",
  "Kevin Garnett","Kirk Hinrich","Lamar Odom","Larry Hughes","Mehmet Okur",
  "Michael Redd","Mike Bibby","Mike Dunleavy","Mike James","Mo Williams",
  "Morris Peterson","Peja Stojakovic","Rafer Alston","Raja Bell","Rashard Lewis",
  "Richard Hamilton","Richard Jefferson","Ricky Davis","Shane Battier",
  "Shawn Marion","Stephon Marbury","Tracy McGrady","Udonis Haslem",
  "Wally Szczerbiak","Yao Ming"
)

options(scipen = 999)

# Safe column suffix
clean_suffix <- function(x) {
  x %>%
    str_replace_all("[^A-Za-z0-9]+", "_") %>%
    str_replace_all("^_+|_+$", "") %>%
    tolower()
}

# Parse through one game
parse_one_game <- function(game_df) {
  tov_triggers <- paste(
    "turnover", "bad pass", "out of bounds", "lost ball",
    "travel", "traveling", "double dribble", "carrying", "palming",
    "backcourt", "8-second", "8 second", "5-second", "5 second",
    "3-second", "3 second", "shot clock", "offensive goaltend", "offensive goaltending",
    sep="|"
  )
  #had to add more tov triggers
  
  game_df %>%
    mutate(
      row_id = row_number(),
      text_clean = text %>%
        str_replace_all("[\u2013\u2014]", "-") %>%  # normalize long dashes
        str_replace_all("\\s+'s", "'s") %>%
        str_squish(),
      lower = tolower(text_clean),

      actor = str_trim(str_extract(
        text_clean,
        paste0(
          "^[^()]*?(?=\\b(",
          paste(
            c(
              "makes","misses","blocks","defensive rebound","offensive rebound",
              "personal foul","shooting foul","turnover","steal","block","assist",
              "jumpball","gains possession",
              # NEW: catch rows like "out of bounds bad pass"
              "bad pass","out of bounds","lost ball","travel","traveling",
              "double dribble","carrying","palming","backcourt","shot clock",
              "3-second","5-second","8-second","offensive goaltend","offensive goaltending"
            ),
            collapse="|"
          ),
          ")\\b)"
        )
      )),

      # roles & helpers
      block_victim = str_match(text_clean, "blocks\\s+([^()]+?)(?:'s|\\s|$)")[,2],
      blocked_by   = str_match(text_clean, "\\(blocked by ([^()]+)\\)")[,2],
      assister     = str_match(text_clean, "\\(([^()]+) assists\\)")[,2],
      steals_paren = str_match(text_clean, "\\(([^()]+) steals\\)")[,2],

      is_ft  = str_detect(lower, "free throw"),
      is_fg_phrase = str_detect(lower, "jump|layup|dunk|hook|fade|step back|pullup|bank|tip") & !is_ft,
      made   = str_detect(lower, "\\bmakes\\b"),
      missed = str_detect(lower, "\\bmisses\\b"),
      is_fg  = is_fg_phrase & (made | missed),

      shooter_name = case_when(
        is_fg & !is.na(actor) ~ actor,
        str_detect(lower, "blocks") & !is.na(block_victim) ~ block_victim,
        is_ft & !is.na(actor) ~ actor,
        TRUE ~ NA_character_
      ),
      blocker_name = case_when(
        str_detect(lower, "blocks") ~ actor,
        !is.na(blocked_by) ~ blocked_by,
        TRUE ~ NA_character_
      ),
      stealer_name = case_when(
        str_detect(lower, "steal") ~ actor,
        !is.na(steals_paren) ~ steals_paren,
        TRUE ~ NA_character_
      ),

      is_orb = str_detect(type_text, regex("^Offensive Rebound$", ignore_case = TRUE)),
      is_drb = str_detect(type_text, regex("^Defensive Rebound$", ignore_case = TRUE)),
      is_pf  = str_detect(type_text, regex("Foul", ignore_case = TRUE)),
      is_tov_typetext = str_detect(type_text, regex("Turnover", ignore_case = TRUE)),
      is_tov_text     = str_detect(lower, tov_triggers),
      is_tov = is_tov_typetext | is_tov_text,

      is_three = str_detect(lower, "three point|3[- ]?pt|3pt"),
      pts_on_make = case_when(
        is_ft & made ~ 1L,
        is_fg & made & is_three ~ 3L,
        is_fg & made ~ 2L,
        TRUE ~ 0L
      )
    ) %>%
    rowwise() %>%
    mutate(
      player_on_event = {
        parts <- c(actor, shooter_name, assister, blocker_name, stealer_name, block_victim)
        parts <- unique(na.omit(parts[parts != ""]))
        if (length(parts) == 0) NA_character_ else paste(parts, collapse = "; ")
      }
    ) %>%
    ungroup() %>%
    select(
      game_id, row_id,
      any_of("clock_display_value"),
      text, type_text, home_score, away_score,
      actor, shooter_name, assister, blocker_name, stealer_name,
      is_fg, is_ft, made, is_orb, is_drb, is_pf, is_tov, pts_on_make,
      player_on_event
    )
}

# Compute one player's Perf/dPerf for ONE game (resets here)
compute_player_perf <- function(parsed, player_name) {
  parsed %>%
    mutate(
      is_shooter  = !is.na(shooter_name) & shooter_name  == player_name,
      is_actor    = !is.na(actor)        & actor         == player_name,
      is_assister = !is.na(assister)     & assister      == player_name,
      is_blocker  = !is.na(blocker_name) & blocker_name  == player_name,
      is_stealer  = !is.na(stealer_name) & stealer_name  == player_name,

      FGA_evt = as.integer(is_shooter & is_fg),
      FG_evt  = as.integer(is_shooter & is_fg & made),
      FTA_evt = as.integer(is_shooter & is_ft),
      FT_evt  = as.integer(is_shooter & is_ft & made),
      PTS_evt = if_else(is_shooter, pts_on_make, 0L),

      ORB_evt = as.integer(is_actor   & is_orb),
      DRB_evt = as.integer(is_actor   & is_drb),
      AST_evt = as.integer(is_assister & is_fg & made),
      BLK_evt = as.integer(is_blocker),
      STL_evt = as.integer(is_stealer),
      PF_evt  = as.integer(is_actor   & is_pf),
      TOV_evt = as.integer(is_actor   & is_tov)
    ) %>%
    arrange(row_id) %>%
    mutate(
      PTS = cumsum(PTS_evt),
      FG  = cumsum(FG_evt),
      FGA = cumsum(FGA_evt),
      FT  = cumsum(FT_evt),
      FTA = cumsum(FTA_evt),
      ORB = cumsum(ORB_evt),
      DRB = cumsum(DRB_evt),
      STL = cumsum(STL_evt),
      AST = cumsum(AST_evt),
      BLK = cumsum(BLK_evt),
      PF  = cumsum(PF_evt),
      TOV = cumsum(TOV_evt),

      Perf = PTS + 0.4*FG - 0.7*FGA - 0.4*(FTA - FT) +
             0.7*ORB + 0.3*DRB + STL + 0.7*AST + 0.6*BLK - 0.4*PF - TOV,
      dPerf = Perf - dplyr::lag(Perf, default = 0)
    ) %>%
    transmute(game_id, row_id, Perf, dPerf)
}

# Build table 
process_one_game <- function(game_df, players) {
  parsed <- parse_one_game(game_df)

  base <- parsed %>%
    select(game_id, row_id,
           any_of("clock_display_value"),
           player_on_event) %>%
    distinct()

  wide <- base
  for (p in players) {
    res <- compute_player_perf(parsed, p)
    suf <- clean_suffix(p)
    res <- res %>%
      rename(!!paste0("Perf_",  suf) := Perf,
             !!paste0("dPerf_", suf) := dPerf)
    wide <- wide %>% left_join(res, by = c("game_id", "row_id"))
  }
  wide
}

# run on all 20 seasons nba_pbp 
out_full <- nba_pbp %>%
  group_by(game_id) %>%
  group_split() %>%
  map_df(~ process_one_game(.x, players))
```

```{r}
View(out_full)
```

```{r}
readr::write_csv(out_full, "out_full.csv")
```
